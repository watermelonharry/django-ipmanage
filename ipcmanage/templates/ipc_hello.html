{% extends "ipc_banner.html" %}
{% block content %}
    <div class="container marketing">

        <!-- Three columns of text below the carousel -->
        <div class="row">
            <div class="col-lg-6">

                <h4>自动恢复</h4>
                <p>按照默认设置开始执行重置设备、更改IP的操作</p>
                <p><a class="btn btn-success" role="button" data-toggle="modal"
                      data-target="#start_scan_modal" data-backdrop="static">自动设置&raquo;</a></p>

            </div>

            <div class="col-lg-6">

                <h4>高级设置</h4>
                <p>查看已保存的MAC-IP表格，可以进行修改、添加等自定义操作</p>
                <p><a class="btn btn-info" href="/ipcmanage/iptables" role="button">高级设置&raquo;</a></p>

            </div>
        </div>
    </div>


    <!--开始执行窗口-->
    <div class="modal fade" id="start_scan_modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>自动执行</h3>
                    <p><b>欢迎使用自动重置功能，请确保执行终端已开启，并阅读以下说明：</b></p>
                    <hr>
                    <p>点击确定后，会自动开始扫描<b>指定网段</b>内的IP地址，获取该地址上设备的MAC信息，查找其绑定IP。随后将该设备<b>恢复出厂设置</b>，并将其IP地址修改为绑定的IP。</p>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form" id="scan_ip_form">
                        <div class="form-group">
                            <label for="edit_mac" class="col-sm-4 control-label">扫描起始IP地址：</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" id="scan_start_str" name="scan_start_str"
                                       placeholder="请输入以“.”分割的IPv4地址" value="192.168.1.2" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit_mac" class="col-sm-4 control-label">扫描数量：</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" id="scan_count_str" name="scan_count_str"
                                       placeholder="请填入扫描数量" value="200" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit_mac" class="col-sm-4 control-label">操作人：*</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" id="scan_people_str" name="scan_people_str"
                                       value={{ user.username }}>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-success" id="confirm_scan_ip_btn">确定</button>
                    <button type="button" class="btn btn-sm btn-danger" data-dismiss="modal"
                            id="confirm_scan_close_btn">关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!--执行中窗口-->
    <div class="modal fade" id="scanning_modal" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>正在执行设置操作</h3>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped active" role="progressbar" id="scanning_probar"
                             style="width: 0%"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-success" id="show_detail_btn" name="">查看详细</button>
                    <button type="button" class="btn btn-sm btn-danger btn_terminate" id="terminate_set_btn">终止</button>
                    <button type="button" class="btn btn-sm btn-danger" data-dismiss="modal" id="scanning_abort_btn">
                        退出
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var timer_id;
        <!--开始执行-->
        $('#confirm_scan_ip_btn').on('click', function () {
            var json_data = {
                'operator_name': $('#scan_people_str').val(),
                'operate_id': getTimeId(),
                'operate_type': 3,
                'ip_start': $('#scan_start_str').val(),
                'ip_count': $('#scan_count_str').val(),
                'run_status': 1,
                'progress': 0
            };
            $('#show_detail_btn').attr("name", json_data.operate_id);
            console.log(json_data);

            $.ajax({
                type: "POST",
                url: "/ipcmanage/api/mission/",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(json_data),
                success: function (e) {
                    console.log("success", e);
                    $('#start_scan_modal').modal('toggle');
                    $('#scanning_modal').modal('toggle');
                    timer_id = window.setInterval(on_time_check, 5000);
                    console.log(timer_id);
                },
                error: function (e) {
                    console.log("failed", e);
                    alert("提交失败，请填入必须的信息。");
                }
            });
        });

        function on_time_check() {
            var op_id = $('#show_detail_btn').attr("name");
            $.ajax({
                type: "GET",
                url: "/ipcmanage/api/mission/" + op_id,
                dataType: "json",
                contentType: "application/json",
                success: function (js_data) {
                    console.log("success", js_data);
                    var total = Number(js_data.ip_count);
                    var fin = Number(js_data.progress);
                    var progress = String(fin * 100 / total) + "%";
                    console.log("request mission progress", progress, timer_id);
                    $('#scanning_probar').attr("style", "width: " + progress);
                    if (total == fin) {
                        window.clearInterval(timer_id);
                        console.log("clear interval")
                        alert('设置完成！')
                    }
                },
                error: function (e) {
                    console.log("failed", e);
                }
            });
        };
        function getTimeId() {
            var time = new Date().getTime();
            return String(time);
        };
        $('#show_detail_btn').on('click', function () {
            window.open('./mission_detail/' + $('#show_detail_btn').attr("name"));
        });

        <!--终止任务-->
        $('#terminate_set_btn').click(function () {
            var js_data = {
                'operate_id': $('#show_detail_btn').attr('name'),
                'operator_name': $('#login_user_name').val(),
                'run_status': 0,
            };
            console.log(js_data);

            $.ajax({
                type: "PUT",
                url: "/ipcmanage/api/mission/" + js_data.operate_id,
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(js_data),
                success: function (e) {
                    console.log("terminate success", e);
                    alert('任务终止成功！');
                    window.clearInterval(timer_id);
                    location.reload();
                },
                error: function (e) {
                    console.log("terminate failed", e);
                    alert("终止任务失败. error：" + e);
                }
            });
        });
    </script>
{% endblock %}